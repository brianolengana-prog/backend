generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id                      String                   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  email                   String                   @unique
  name                    String
  passwordHash            String?                  @map("password_hash")
  provider                String                   @default("email")
  providerId              String?                  @map("provider_id")
  emailVerified           Boolean                  @default(false) @map("email_verified")
  twoFactorEnabled        Boolean                  @default(false) @map("two_factor_enabled")
  twoFactorSecret         String?                  @map("two_factor_secret")
  loginAttempts           Int                      @default(0) @map("login_attempts")
  lockedUntil             DateTime?                @map("locked_until")
  lastLoginAt             DateTime?                @map("last_login_at")
  createdAt               DateTime                 @default(now()) @map("created_at")
  updatedAt               DateTime                 @updatedAt @map("updated_at")
  stripeCustomerId        String?                  @map("stripe_customer_id")
  emailVerificationTokens EmailVerificationToken[]
  passwordResetTokens     PasswordResetToken[]
  securityAuditLogs       SecurityAuditLog[]
  sessions                Session[]
  twoFactorCodes          TwoFactorCode[]
  usage                   Usage[]

  @@map("users")
}

model Profile {
  id          String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId      String       @unique @map("user_id") @db.Uuid
  displayName String?      @map("display_name")
  avatarUrl   String?      @map("avatar_url")
  createdAt   DateTime     @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime     @updatedAt @map("updated_at") @db.Timestamptz(6)
  callSheets  CallSheet[]
  contacts    Contact[]
  jobs        Job[]
  productions Production[]

  @@map("profiles")
}

model Job {
  id                String      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId            String      @map("user_id") @db.Uuid
  title             String
  fileName          String?     @map("file_name")
  fileUrl           String?     @map("file_url")
  status            JobStatus   @default(PROCESSING)
  processedContacts Json?       @map("processed_contacts")
  productionId      String?     @map("production_id") @db.Uuid
  createdAt         DateTime    @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt         DateTime    @updatedAt @map("updated_at") @db.Timestamptz(6)
  fileHash          String?     @map("file_hash") @db.VarChar(64)
  fileSize          Int?        @map("file_size")
  contacts          Contact[]
  production        Production? @relation(fields: [productionId], references: [id])
  profile           Profile     @relation(fields: [userId], references: [userId], onDelete: Cascade)

  @@index([userId, fileHash])
  @@index([userId, status, createdAt(sort: Desc)])
  @@index([fileHash, createdAt(sort: Desc)])
  @@map("jobs")
}

model Contact {
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  jobId      String   @map("job_id") @db.Uuid
  userId     String   @map("user_id") @db.Uuid
  name       String
  email      String?
  phone      String?
  role       String?
  company    String?
  isSelected Boolean  @default(true) @map("is_selected")
  createdAt  DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt  DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)
  job        Job      @relation(fields: [jobId], references: [id], onDelete: Cascade)
  profile    Profile  @relation(fields: [userId], references: [userId], onDelete: Cascade)

  @@index([jobId], map: "contacts_jobId_idx")
  @@index([name])
  @@index([role])
  @@index([userId, createdAt(sort: Desc)], map: "contacts_userId_createdAt_idx")
  @@index([userId], map: "contacts_userId_idx")
  @@index([userId, jobId], map: "contacts_userId_jobId_idx")
  @@index([userId, role], map: "contacts_userId_role_idx")
  @@map("contacts")
}

model Production {
  id          String      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId      String      @map("user_id") @db.Uuid
  name        String
  description String?
  status      String      @default("active")
  createdAt   DateTime    @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime    @updatedAt @map("updated_at") @db.Timestamptz(6)
  callSheets  CallSheet[]
  jobs        Job[]
  profile     Profile     @relation(fields: [userId], references: [userId], onDelete: Cascade)

  @@map("productions")
}

model CallSheet {
  id           String     @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId       String     @map("user_id") @db.Uuid
  productionId String     @map("production_id") @db.Uuid
  title        String
  shootDate    String     @map("shoot_date")
  location     String?
  createdAt    DateTime   @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt    DateTime   @updatedAt @map("updated_at") @db.Timestamptz(6)
  production   Production @relation(fields: [productionId], references: [id], onDelete: Cascade)
  profile      Profile    @relation(fields: [userId], references: [userId], onDelete: Cascade)

  @@map("call_sheets")
}

model PasswordResetToken {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  token     String   @unique
  expiresAt DateTime @map("expires_at")
  used      Boolean  @default(false)
  createdAt DateTime @default(now()) @map("created_at")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("password_reset_tokens")
}

model EmailVerificationToken {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  token     String   @unique
  expiresAt DateTime @map("expires_at")
  used      Boolean  @default(false)
  createdAt DateTime @default(now()) @map("created_at")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("email_verification_tokens")
}

model TwoFactorCode {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  code      String
  expiresAt DateTime @map("expires_at")
  used      Boolean  @default(false)
  createdAt DateTime @default(now()) @map("created_at")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("two_factor_codes")
}

model SecurityAuditLog {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId    String?  @map("user_id") @db.Uuid
  action    String
  ipAddress String?  @map("ip_address")
  userAgent String?  @map("user_agent")
  success   Boolean
  details   Json?
  createdAt DateTime @default(now()) @map("created_at")
  user      User?    @relation(fields: [userId], references: [id])

  @@map("security_audit_log")
}

model AuditLog {
  id           String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId       String?  @map("user_id") @db.Uuid
  action       String   @db.VarChar(100)
  severity     String   @db.VarChar(20)
  resourceType String?  @map("resource_type") @db.VarChar(100)
  resourceId   String?  @map("resource_id") @db.VarChar(255)
  ipAddress    String?  @map("ip_address") @db.VarChar(45)
  userAgent    String?  @map("user_agent") @db.Text
  metadata     Json?
  success      Boolean  @default(true)
  errorMessage String?  @map("error_message") @db.Text
  createdAt    DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  @@index([userId, createdAt(sort: Desc)])
  @@index([action, createdAt(sort: Desc)])
  @@index([severity, createdAt(sort: Desc)])
  @@index([resourceType, resourceId])
  @@index([success, createdAt(sort: Desc)])
  @@index([createdAt(sort: Desc)])
  @@map("audit_logs")
}

model Session {
  id           String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId       String   @map("user_id") @db.Uuid
  accessToken  String   @unique @map("access_token")
  refreshToken String   @unique @map("refresh_token")
  expiresAt    DateTime @map("expires_at")
  isActive     Boolean  @default(true) @map("is_active")
  ipAddress    String?  @map("ip_address")
  userAgent    String?  @map("user_agent")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model Usage {
  id                String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId            String   @map("user_id") @db.Uuid
  month             String
  jobsProcessed     Int      @default(0) @map("jobs_processed")
  contactsExtracted Int      @default(0) @map("contacts_extracted")
  apiCalls          Int      @default(0) @map("api_calls")
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, month])
  @@map("usage")
}

model Subscription {
  id                   String              @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId               String              @map("user_id") @db.Uuid
  stripeCustomerId     String              @map("stripe_customer_id")
  stripeSubscriptionId String?             @unique @map("stripe_subscription_id")
  status               SubscriptionState   @default(INCOMPLETE)
  priceId              String              @map("price_id")
  currentPeriodStart   DateTime            @map("current_period_start") @db.Timestamptz(6)
  currentPeriodEnd     DateTime            @map("current_period_end") @db.Timestamptz(6)
  cancelAtPeriodEnd    Boolean             @default(false) @map("cancel_at_period_end")
  createdAt            DateTime            @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt            DateTime            @updatedAt @map("updated_at") @db.Timestamptz(6)
  stateTransitions     SubscriptionStateTransition[]

  @@index([status])
  @@index([userId, status])
  @@map("subscriptions")
}

model SubscriptionStateTransition {
  id             String            @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  subscriptionId String            @map("subscription_id") @db.Uuid
  fromState      SubscriptionState @map("from_state")
  toState        SubscriptionState @map("to_state")
  trigger        String            @db.VarChar(100) // 'webhook', 'user_action', 'system', 'admin'
  triggerId      String?          @map("trigger_id") @db.VarChar(255) // webhook event ID, user ID, etc.
  reason         String?          @db.Text
  metadata       Json?
  ipAddress      String?           @map("ip_address") @db.VarChar(45)
  userAgent      String?           @map("user_agent") @db.Text
  createdAt      DateTime          @default(now()) @map("created_at") @db.Timestamptz(6)
  subscription   Subscription      @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)

  @@index([subscriptionId, createdAt(sort: Desc)])
  @@index([fromState, toState])
  @@index([trigger])
  @@map("subscription_state_transitions")
}

enum SubscriptionState {
  INCOMPLETE
  INCOMPLETE_EXPIRED
  TRIALING
  ACTIVE
  PAST_DUE
  CANCELED
  UNPAID
  PENDING_CANCELLATION

  @@map("subscription_state")
}

model Payment {
  id                    String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  stripePaymentIntentId String?  @map("stripe_payment_intent_id")
  stripeInvoiceId       String?  @map("stripe_invoice_id")
  amount                Int
  currency              String   @default("usd")
  status                String
  createdAt             DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  @@map("payments")
}

model WebhookEvent {
  id                String            @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  idempotencyKey    String            @unique @map("idempotency_key") @db.VarChar(255)
  eventId           String            @unique @map("event_id") @db.VarChar(255)
  eventType         String            @map("event_type") @db.VarChar(100)
  processed         Boolean           @default(false)
  processedAt       DateTime?         @map("processed_at") @db.Timestamptz(6)
  processingTimeMs Int?               @map("processing_time_ms")
  errorMessage     String?            @map("error_message") @db.Text
  retryCount       Int                @default(0) @map("retry_count")
  maxRetries       Int                @default(3) @map("max_retries")
  status           WebhookEventStatus @default(PENDING)
  rawPayload       Json?              @map("raw_payload")
  metadata         Json?             
  ipAddress        String?            @map("ip_address") @db.VarChar(45)
  userAgent        String?            @map("user_agent") @db.Text
  createdAt        DateTime          @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt        DateTime          @updatedAt @map("updated_at") @db.Timestamptz(6)
  deadLetterQueue  DeadLetterQueue?

  @@index([eventId])
  @@index([eventType])
  @@index([processed, status])
  @@index([createdAt(sort: Desc)])
  @@index([idempotencyKey])
  @@map("webhook_events")
}

model DeadLetterQueue {
  id                String            @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  webhookEventId    String            @unique @map("webhook_event_id") @db.Uuid
  eventId           String            @map("event_id") @db.VarChar(255)
  eventType         String            @map("event_type") @db.VarChar(100)
  errorCategory     String            @map("error_category") @db.VarChar(50)
  errorMessage      String            @map("error_message") @db.Text
  finalAttempt      Int               @map("final_attempt")
  rawPayload        Json?             @map("raw_payload")
  metadata          Json?
  ipAddress         String?           @map("ip_address") @db.VarChar(45)
  userAgent         String?           @map("user_agent") @db.Text
  resolved          Boolean           @default(false)
  resolvedAt        DateTime?         @map("resolved_at") @db.Timestamptz(6)
  resolvedBy        String?           @map("resolved_by") @db.VarChar(255)
  resolutionNotes   String?           @map("resolution_notes") @db.Text
  createdAt         DateTime          @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt         DateTime          @updatedAt @map("updated_at") @db.Timestamptz(6)
  webhookEvent      WebhookEvent      @relation(fields: [webhookEventId], references: [id], onDelete: Cascade)

  @@index([eventType])
  @@index([errorCategory])
  @@index([resolved, createdAt(sort: Desc)])
  @@index([createdAt(sort: Desc)])
  @@map("dead_letter_queue")
}

enum WebhookEventStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  RETRYING
  DEAD_LETTER

  @@map("webhook_event_status")
}

enum JobStatus {
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED

  @@map("job_status")
}
